#!/bin/bash
## Semi-automatic script to
## download build and install
## ffmpeg-full on arch linux
## Req.: grep hash head tail wc git wget make gcc...
## Use: ./get_ffmpeg-full_arch
## Author Andrew S.
## Licence GPL
## https://github.com/quarkscript/Build_from_source

## get required Simple_func_scripts
wget https://github.com/quarkscript/Simple_func_scripts/raw/master/adnlalwp
wget https://github.com/quarkscript/Simple_func_scripts/raw/master/cxx_flags
wget https://github.com/quarkscript/Simple_func_scripts/raw/master/mcolif
wget https://github.com/quarkscript/Simple_func_scripts/raw/master/mpbsmpks
chmod +x adnlalwp cxx_flags mcolif mpbsmpks
./cxx_flags

## For make a local hardware independent builds uncomment next line
#echo "">cxxflags.txt

mkdir aur_depends
cp adnlalwp cxx_flags mcolif mpbsmpks cxxflags.txt aur_depends
cp aur_depends ffmpeg -r
cd aur_depends
 aur_ffdep=('https://aur.archlinux.org/rockchip-mpp.git
             https://aur.archlinux.org/libmysofa-git.git
             https://aur.archlinux.org/xavs.git
             https://aur.archlinux.org/vo-amrwbenc.git
             https://aur.archlinux.org/shine.git
             https://aur.archlinux.org/sndio.git
             https://aur.archlinux.org/libopenmpt-svn.git
             https://aur.archlinux.org/openh264.git
             https://aur.archlinux.org/kvazaar.git
             https://aur.archlinux.org/libilbc.git
             https://aur.archlinux.org/flite1-patched.git
             https://aur.archlinux.org/libbs2b.git
             https://aur.archlinux.org/chromaprint-fftw.git
             https://aur.archlinux.org/blackmagic-decklink-sdk.git
             https://aur.archlinux.org/libmfx.git
             https://aur.archlinux.org/vmaf.git')
for i in $(echo $aur_ffdep )
    do
    git clone $i
done

## get req packs
for i in $(ls -d */ | sed -e 's/\///g' | sed -e 's/ffmpeg-full//g' )
    do
    cd $i
    req_pack_list+=" "$(cat PKGBUILD | grep "depends=" | sed -e 's/)//g' | sed -e "s/'//g" | sed -e 's/makedepends=(//g' | sed -e 's/depends=(//g')
    cd ..
done

cd ../ffmpeg
git clone https://aur.archlinux.org/ffmpeg-full.git
cd ffmpeg-full

## get additional ffmpeg dependencies
for k in $(grep -n '# of' PKGBUILD | grep -o -E "[0-9][0-9]")
    do
    for m in $(grep -n '# AUR' PKGBUILD | grep -o -E "[0-9][0-9]")
        do
        if [ "$k" -lt "$m" ]
            then
            head -n $(($m-1)) PKGBUILD >tst.tmp
            tail -n $(($m-$k-1)) tst.tmp >>1.tmp
            rm -f tst.tmp
            break
        fi
    done
done
ffmpegfullreq=$(cat 1.tmp | sed -e "s/'//g")
rm -f 1.tmp
cd ../..
req_pack_list+=" "$(echo $ffmpegfullreq)

## rm duplicates
tr=""
for i in $req_pack_list
    do
    if ! $(echo $tr | grep "$i" -q)
        then
        tr+=" "$i
    fi
done
req_pack_list=$tr
tr=""

## test req packages
installed_list=$(pacman -Qq)
for i in $req_pack_list
    do
    tr+=" "$(echo $i | grep -v "$installed_list" )
done
#if [ "$tr" != " " ]
#    then
    echo !!!
    echo due to reorganize arch repo and not synced ffmpeg-full 
    echo dependencies with it, some of packages may reinstall
    echo !!!
    echo super-user password required for install $tr
    sudo pacman -S $tr
#fi

## make and install req. aur packages
cd aur_depends
./mpbsmpks
echo !!!
echo super-user password required for install ffmpeg aur depends
sudo pacman -U *pkg.tar.xz
echo
cd ..

## make and install ffmpeg-full
cd ffmpeg
extrafl='--extra-cxxflags=" '
extrafl+=$(cat cxxflags.txt)
extrafl+=' " \'
cd ffmpeg-full
../adnlalwp 'PKGBUILD' 'prefix=' "$extrafl" 
 cd ..
./mpbsmpks
echo !!!
echo super-user password is required for install ffmpeg-full
sudo pacman -U *pkg.tar.xz
